{% extends 'clinic.html' %}
{% block title %}Check-ins | Om Gayatri Clinic{% endblock title %}
{% block head %}
<style>
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(20,184,166,0.1)); border: 1px solid var(--border); border-radius: 12px; padding: 16px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }

    table { width: 100%; border-collapse: collapse; }
    table thead { background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(20,184,166,0.12)); }
    table th { padding: 12px; text-align: left; font-weight: 600; color: var(--text); border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; }
    table th:hover { background: rgba(139,92,246,0.15); }
    table td { padding: 12px; border-bottom: 1px solid var(--border); }
    table tr:hover { background: rgba(139,92,246,0.05); }
    .sort-indicator { margin-left: 4px; font-size: 10px; }

    .badge.status-early { background: rgba(16,185,129,0.15); color: #059669; }
    .badge.status-late { background: rgba(239,68,68,0.12); color: #b91c1c; }
    .badge.status-on_time { background: rgba(99,102,241,0.12); color: #4f46e5; }
    .badge.doctor-ami { background: #d6e8ff; color: #4b9dd0;}

    .filters { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .filters input, .filters select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-soft); color: var(--text); }
    /* Improved filter button */
    .filters .btn { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: linear-gradient(90deg,#7c3aed,#06b6d4); color: #fff; border: none; border-radius: 10px; box-shadow: 0 6px 14px rgba(124,58,237,0.12); cursor: pointer; transition: transform .08s ease, box-shadow .08s ease, opacity .08s ease; }
    .filters .btn svg { width: 14px; height: 14px; flex: none; }
    .filters .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(124,58,237,0.18); }
    .filters .btn:active { transform: translateY(0); }
    .filters .clear-link { margin-left: 6px; color: var(--muted); text-decoration: none; padding: 6px 10px; border-radius: 8px; border: 1px solid transparent; background: transparent; }
    .filters .clear-link:hover { background: #f8fafc; border-color: var(--border); color: #374151; }

    .pagination { display: flex; gap: 8px; justify-content: center; margin-top: 20px; }
    .pagination a, .pagination span { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; }
    .pagination a:hover { background: rgba(139,92,246,0.1); }
    .pagination .current { background: var(--primary); color: white; border-color: var(--primary); }
</style>
{% endblock head %}
{% block body %}
<div class="header">
    <h1>Check-ins Details</h1>
    <a class="btn" href="{% url 'Anand_Clinic:index' %}">← Back to Home</a>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ total_checkins }}</div>
        <div class="stat-label">Total Check-ins</div>
    </div>
    <div class="stat-card" style="border-color: rgba(16,185,129,0.3);">
        <div class="stat-value" style="color: #059669;">{{ early_count }}</div>
        <div class="stat-label">Early</div>
    </div>
    <div class="stat-card" style="border-color: rgba(99,102,241,0.3);">
        <div class="stat-value" style="color: #4f46e5;">{{ on_time_count }}</div>
        <div class="stat-label">On Time</div>
    </div>
    <div class="stat-card" style="border-color: rgba(239,68,68,0.3);">
        <div class="stat-value" style="color: #b91c1c;">{{ late_count }}</div>
        <div class="stat-label">Late</div>
    </div>
</div>

<div class="card">
    <h2>Filters & Search</h2>
    {% if debug_doctors %}<div style="background:#fff3cd; padding:8px; margin-bottom:12px; border-radius:6px; font-size:12px;">Debug: Actual doctor codes in DB: {{ debug_doctors|join:", " }}</div>{% endif %}
    <form method="get" class="filters">
        <input type="text" name="search" placeholder="Search by patient name or case no..." value="{{ request.GET.search }}">
        <select name="status">
            <option value="">All Statuses</option>
            <option value="early" {% if request.GET.status == 'early' %}selected{% endif %}>Early</option>
            <option value="on_time" {% if request.GET.status == 'on_time' %}selected{% endif %}>On Time</option>
            <option value="late" {% if request.GET.status == 'late' %}selected{% endif %}>Late</option>
        </select>
        <select name="doctor">
            <option value="">All Doctors ({{ total_checkins }})</option>
            <option value="dr_1" {% if request.GET.doctor == 'dr_1' %}selected{% endif %}>Dr. Ami Bhatt ({{ ami_count }})</option>
            <option value="dr_2" {% if request.GET.doctor == 'dr_2' %}selected{% endif %}>Dr. Kaushal Bhatt ({{ kaushal_count }})</option>
        </select>
        <input type="date" name="date" value="{{ request.GET.date }}">
        <label style="font-size:12px; color:var(--muted);">Scheduled</label>
        <input type="datetime-local" name="scheduled" value="{{ request.GET.scheduled }}">
        <label style="font-size:12px; color:var(--muted);">Check-in</label>
        <input type="datetime-local" name="checkin" value="{{ request.GET.checkin }}">
        <button type="submit" class="btn" title="Apply filters">
            <!-- simple filter funnel icon -->
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <path d="M3 5h18v2L13 13v6l-2 1v-7L3 7V5z" fill="currentColor" />
            </svg>
            Filter
        </button>
        <a href="?" class="clear-link">Clear</a>
    </form>
</div>

<div class="card">
    <table>
        <thead>
            <tr>
                <th onclick="sortTable(this, 'name')">Patient Name <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'case_no')">Case No <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'doctor')">Doctor <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'scheduled')">Scheduled <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'checkin')">Check-in Time <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'status')">Status <span class="sort-indicator">▼▲</span></th>
                <th onclick="sortTable(this, 'diff')">Minutes Diff <span class="sort-indicator">▼▲</span></th>
            </tr>
        </thead>
        <tbody>
            {% for checkin in checkins %}
            <tr>
                <td><strong>{{ checkin.followup.patient.name }}</strong></td>
                <td>{{ checkin.followup.patient.case_no }}</td>
                <td><span class="badge {% if 'Ami' in checkin.followup.patient.get_doctor_display %}doctor-ami{% endif %}">{{ checkin.followup.patient.get_doctor_display }}</span></td>
                <td>{{ checkin.followup.scheduled_date|date:"M d, Y H:i" }}</td>
                <td>{{ checkin.checkin_time|date:"M d, Y H:i" }}</td>
                <td>
                    <span class="badge status-{{ checkin.status }}">
                        {% if checkin.status == 'early' %}Early
                        {% elif checkin.status == 'late' %}Late
                        {% else %}On Time{% endif %}
                    </span>
                </td>
                <td style="text-align:center; font-weight:600;">{{ checkin.minutes_difference }} min</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align:center; padding:30px; color:var(--muted);">No check-ins found</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if is_paginated %}
    <div class="pagination">
        {% if page_obj.has_previous %}
            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.scheduled %}&scheduled={{ request.GET.scheduled }}{% endif %}{% if request.GET.checkin %}&checkin={{ request.GET.checkin }}{% endif %}">First</a>
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.scheduled %}&scheduled={{ request.GET.scheduled }}{% endif %}{% if request.GET.checkin %}&checkin={{ request.GET.checkin }}{% endif %}">← Previous</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <span class="current">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.scheduled %}&scheduled={{ request.GET.scheduled }}{% endif %}{% if request.GET.checkin %}&checkin={{ request.GET.checkin }}{% endif %}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.scheduled %}&scheduled={{ request.GET.scheduled }}{% endif %}{% if request.GET.checkin %}&checkin={{ request.GET.checkin }}{% endif %}">Next →</a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}{% if request.GET.scheduled %}&scheduled={{ request.GET.scheduled }}{% endif %}{% if request.GET.checkin %}&checkin={{ request.GET.checkin }}{% endif %}">Last</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    function sortTable(th, dataType) {
        const table = th.closest('table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr:not(:last-child)'));
        const colIndex = Array.from(th.parentNode.children).indexOf(th);
        
        const isAsc = th.classList.toggle('sort-asc');
        
        rows.sort((a, b) => {
            let aVal = a.children[colIndex].textContent.trim();
            let bVal = b.children[colIndex].textContent.trim();

            // Handle numeric columns
            if (dataType === 'diff' || dataType === 'case_no') {
                aVal = parseInt(aVal) || 0;
                bVal = parseInt(bVal) || 0;
            }

            if (aVal < bVal) return isAsc ? -1 : 1;
            if (aVal > bVal) return isAsc ? 1 : -1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));

        // Update sort indicators
        table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc'));
        if (isAsc) th.classList.add('sort-asc');
    }
</script>
{% endblock body %}
