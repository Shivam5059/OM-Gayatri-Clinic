{% extends 'clinic.html' %}
{% block title %}Patients | Om Gayatri Clinic{% endblock title %}
{% block head %}
<style>
    .follow-btn {
        background: linear-gradient(135deg, #8b5cf6, #14b8a6);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: transform 120ms ease, box-shadow 200ms ease, filter 120ms ease;
        box-shadow: 0 4px 12px rgba(139,92,246,0.3);
    }
    .follow-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(139,92,246,0.4); filter: brightness(1.05); }
    .follow-btn:disabled {
        background: #cbd5e1;
        cursor: not-allowed;
        opacity: 0.7;
        box-shadow: none;
    }
    .follow-btn.scheduled {
        background: #cbd5e1;
        color: #64748b;
    }
</style>
{% endblock head %}
{% block body %}
<div class="header">
    <h1>Patients</h1>
    <a class="btn" href="{% url 'Anand_Clinic:add_patient' %}">Add New Patient</a>
</div>
<div class="card">
    <ul class="list" id="patient-list">
        {% for patient in patients %}
        <li>
            <div>
                <strong>{{ patient.name }}</strong>
                <span class="badge {% if 'Ami' in patient.get_doctor_display %}doctor-ami{% endif %}">{{ patient.get_doctor_display }}</span>
            </div>
            {% comment %} Minimal follow-up button only; nothing else in tile changed {% endcomment %}
            {% if patient.has_scheduled_followup %}
            <button class="follow-btn scheduled" data-patient-id="{{ patient.pk }}" disabled>Scheduled</button>
            {% else %}
            <button class="follow-btn" data-patient-id="{{ patient.pk }}">Follow up</button>
            {% endif %}
            <a class="btn" href="{% url 'Anand_Clinic:patient_details' patient.case_no %}">View Details</a>
        </li>
        {% empty %}
        <li>No patients found.</li>
        {% endfor %}

        <!-- Follow-up modal -->
    <div id="followup-modal" style="display:none; position:fixed; left:0; right:0; top:0; bottom:0;
            align-items:center; justify-content:center; background:rgba(0,0,0,0.5);">
        <div style="background:#fff; padding:20px; border-radius:8px; width:320px;">
            <h3>Schedule Follow-up</h3>
            <form id="followup-form">
            <input type="hidden" name="patient_id" id="fu-patient-id">
            <label>
                Date & time
                <input id="fu-datetime" name="scheduled_date" type="datetime-local" required>
            </label>
            <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" id="fu-cancel">Cancel</button>
                <button type="submit">Schedule</button>
            </div>
            </form>
            <div id="fu-error" style="color:red; margin-top:8px; display:none;"></div>
        </div>
    </div>

    </ul>
</div>
{% endblock body %}

{% block scripts %}
<script>
    // Follow-up scheduling modal and AJAX handler for patient list
    (function(){
        // Get CSRF token from Django
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const modal = document.getElementById('followup-modal');
        const form = document.getElementById('followup-form');
        const dtInput = document.getElementById('fu-datetime');
        const hiddenPatient = document.getElementById('fu-patient-id');
        const errorDiv = document.getElementById('fu-error');

        // open modal when Follow up button clicked
        document.querySelectorAll('.follow-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Don't open modal if button is disabled (already scheduled)
                if (btn.disabled) return;
                
                const pid = btn.getAttribute('data-patient-id');
                hiddenPatient.value = pid;
                errorDiv.style.display = 'none';
                // set min to now in local datetime-local format YYYY-MM-DDTHH:MM
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // adjust
                const iso = now.toISOString().slice(0,16);
                dtInput.min = iso;
                dtInput.value = iso; // prefill to now
                modal.style.display = 'flex';
                dtInput.focus();
            });
        });

        document.getElementById('fu-cancel').addEventListener('click', () => {
            modal.style.display = 'none';
        });

        form.addEventListener('submit', function(ev) {
            ev.preventDefault();
            errorDiv.style.display = 'none';
            const patient_id = hiddenPatient.value;
            const scheduled_date = dtInput.value; // format: YYYY-MM-DDTHH:MM

            if (!patient_id || !scheduled_date) {
                errorDiv.innerText = 'Please choose date and time.';
                errorDiv.style.display = 'block';
                return;
            }

            // Basic client-side check
            const chosen = new Date(scheduled_date);
            const now = new Date();
            if (chosen < now) {
                errorDiv.innerText = 'Please choose a future date/time.';
                errorDiv.style.display = 'block';
                return;
            }

            const formData = new FormData();
            formData.append('patient_id', patient_id);
            formData.append('scheduled_date', scheduled_date);

            const csrftoken = getCookie('csrftoken');
            fetch("{% url 'Anand_Clinic:followup_create_ajax' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: formData,
                credentials: 'same-origin'
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    errorDiv.innerText = data.error || 'Failed to schedule follow-up';
                    errorDiv.style.display = 'block';
                    return;
                }

                // success: update button to Scheduled
                const btn = document.querySelector('.follow-btn[data-patient-id="'+patient_id+'"]');
                if (btn) {
                    btn.textContent = 'Scheduled';
                    btn.disabled = true;
                    btn.classList.add('scheduled');
                }

                modal.style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                errorDiv.innerText = 'Network error';
                errorDiv.style.display = 'block';
            });
        });

        // Refresh patient list every 10s
    function refreshPatientList() {
        fetch("{% url 'Anand_Clinic:ajax_patient_list' %}")
            .then(res => res.json())
            .then(data => {
                patientList.innerHTML = data.html;
            })
            .catch(err => console.error("Failed to fetch patients:", err));
    }

    setInterval(refreshPatientList, 10000);
    })();
</script>
{% endblock scripts %}