{% extends 'clinic.html' %}
{% block title %}Prescription Generator{% endblock title %}
{% block body %}
<div class="header">
    <h1>Prescription Generator</h1>
    <div class="actions">
        <a class="btn" href="{% url 'Anand_Clinic:prescription_generator_list' %}">All Prescriptions</a>
        <a class="btn secondary" href="{% url 'Anand_Clinic:index' %}">Back to Home</a>
    </div>
</div>

<div class="main-content-grid">
    <div class="card">
        <h2>Create Prescription</h2>
        <form method="post" id="prescriptionGenForm">
            {% csrf_token %}
            {% if prescription %}<input type="hidden" id="isEditFlag" value="1">{% endif %}
            <div class="form-grid" style="grid-template-columns: repeat(2, 1fr);">
                <div class="form-group">
                    <label>Patient</label>
                    <select id="patientSelect" name="patient" required>
                        <option value="">Select Patient</option>
                        {% for p in patients %}
                        <option value="{{ p.pk }}" data-case="{{ p.case_no }}" {% if prescription and p.pk == prescription.patient.pk %}selected{% endif %}>{{ p.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Case Number</label>
                    <input type="number" id="caseNumber" name="case_number" readonly required {% if prescription %}value="{{ prescription.case_number }}"{% endif %}>
                </div>
            </div>

            <div class="card" style="margin-top:12px;">
                <h3>Prescribing Doctor(s)</h3>
                <div class="doctor-compact">
                    <label class="doc-pill">
                        <input type="checkbox" id="docAmi" name="doctor_ami" {% if prescription and prescription.prescribed_by_ami %}checked{% endif %}>
                        <span>Ami</span>
                    </label>
                    <label class="doc-pill">
                        <input type="checkbox" id="docKaushal" name="doctor_kaushal" {% if prescription and prescription.prescribed_by_kaushal %}checked{% endif %}>
                        <span>Kaushal</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Instruction Type</label>
                <select id="instructionType" name="instruction_type" required>
                    <option value="first">First Day Instructions</option>
                    <option value="next">From Next Day Onwards</option>
                </select>
            </div>

            <div class="form-group">
                <label>Language</label>
                <select id="languageSelect" name="language" required>
                    <option value="en" {% if prescription and prescription.language == 'en' %}selected{% endif %}>English</option>
                    <option value="gu" {% if prescription and prescription.language == 'gu' %}selected{% endif %}>Gujarati</option>
                </select>
            </div>

            <div id="firstDaySection" class="card" style="margin-top:12px;{% if prescription %} display:block;{% endif %}">
                <h3>First Day Instructions</h3>
                <div id="firstList">
                    {% if prescription %}
                        {% for fd in prescription.first_day_instructions.all %}
                        <div class="inline-row">
                            <select name="first-{{ forloop.counter0 }}-size" required>
                              <option value="">Size</option>
                              <option value="small" {% if fd.size_of_bottle == 'small' %}selected{% endif %}>small</option>
                              <option value="medium" {% if fd.size_of_bottle == 'medium' %}selected{% endif %}>medium</option>
                              <option value="large" {% if fd.size_of_bottle == 'large' %}selected{% endif %}>large</option>
                            </select>
                            <input type="text" name="first-{{ forloop.counter0 }}-label" placeholder="Label" required value="{{ fd.label }}">
                            <input type="text" name="first-{{ forloop.counter0 }}-pills" placeholder="No. of pills" required value="{{ fd.no_of_pill }}">
                            <select name="first-{{ forloop.counter0 }}-time" required>
                              <option value="Day" {% if fd.time_of_day == 'Day' %}selected{% endif %}>Day</option>
                              <option value="Morning" {% if fd.time_of_day == 'Morning' %}selected{% endif %}>Morning</option>
                              <option value="Night" {% if fd.time_of_day == 'Night' %}selected{% endif %}>Night</option>
                            </select>
                            <input type="text" name="first-{{ forloop.counter0 }}-special" placeholder="Special instruction" value="{{ fd.special_instruction }}">
                            <button type="button" class="remove-btn">Remove</button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn" id="addFirst">Add another medicine</button>
                <input type="hidden" id="firstTotal" name="first_TOTAL" value="{% if prescription %}{{ prescription.first_day_instructions.count }}{% else %}0{% endif %}">
            </div>

            <div id="nextDaySection" class="card" style="margin-top:12px; {% if prescription %}display:block;{% else %}display:none;{% endif %}">
                <h3>From Next Day Onwards</h3>
                <div id="nextList">
                    {% if prescription %}
                        {% for nd in prescription.next_day_instructions.all %}
                        <div class="inline-row next">
                            <input type="text" name="next-{{ forloop.counter0 }}-bottle" placeholder="Bottle No." required value="{{ nd.bottle_no }}">
                            <input type="text" name="next-{{ forloop.counter0 }}-pills" placeholder="No. of pills" required value="{{ nd.no_of_pill }}">
                            <select name="next-{{ forloop.counter0 }}-dose" required>
                              <option value="one" {% if nd.dose == 'one' %}selected{% endif %}>one</option>
                              <option value="two" {% if nd.dose == 'two' %}selected{% endif %}>two</option>
                              <option value="three" {% if nd.dose == 'three' %}selected{% endif %}>three</option>
                              <option value="four" {% if nd.dose == 'four' %}selected{% endif %}>four</option>
                              <option value="five" {% if nd.dose == 'five' %}selected{% endif %}>five</option>
                            </select>
                            <select name="next-{{ forloop.counter0 }}-time" required>
                              <option value="Day" {% if nd.time_of_day == 'Day' %}selected{% endif %}>Day</option>
                              <option value="Morning" {% if nd.time_of_day == 'Morning' %}selected{% endif %}>Morning</option>
                              <option value="Night" {% if nd.time_of_day == 'Night' %}selected{% endif %}>Night</option>
                            </select>
                            <button type="button" class="remove-btn">Remove</button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
                <button type="button" class="btn" id="addNext">Add another medicine</button>
                <input type="hidden" id="nextTotal" name="next_TOTAL" value="{% if prescription %}{{ prescription.next_day_instructions.count }}{% else %}0{% endif %}">
            </div>

            <div class="form-actions">
                <button type="submit" class="btn">Generate</button>
            </div>
        </form>
    </div>

    <div class="card">
        <h2>Live Preview</h2>
        <pre id="preview" style="white-space: pre-wrap; background: var(--bg-soft); border:1px solid var(--border); padding:12px; border-radius:12px; min-height:300px;"></pre>
    </div>
</div>

<style>
.inline-row { display:grid; grid-template-columns: repeat(5, 1fr); gap:10px; margin-bottom:10px; }
.inline-row.next { grid-template-columns: repeat(4, 1fr); }
.remove-btn { background:#ef4444; color:#fff; border:none; border-radius:8px; padding:8px 10px; }
.doctor-compact { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.doc-pill { display:flex; align-items:center; gap:6px; background: var(--bg-soft); border:1px solid var(--border); border-radius:999px; padding:6px 10px; }
.doc-pill input { width:auto; }
</style>

<script>
const patientSelect = document.getElementById('patientSelect')
const caseNumber = document.getElementById('caseNumber')
const instructionType = document.getElementById('instructionType')
const firstSection = document.getElementById('firstDaySection')
const nextSection = document.getElementById('nextDaySection')
const firstList = document.getElementById('firstList')
const nextList = document.getElementById('nextList')
const addFirst = document.getElementById('addFirst')
const addNext = document.getElementById('addNext')
const firstTotal = document.getElementById('firstTotal')
const nextTotal = document.getElementById('nextTotal')
const preview = document.getElementById('preview')
const isEdit = !!document.getElementById('isEditFlag')
const languageSelect = document.getElementById('languageSelect')

patientSelect.addEventListener('change', function() {
  const opt = this.options[this.selectedIndex]
  caseNumber.value = opt.getAttribute('data-case') || ''
  updatePreview()
})

instructionType.addEventListener('change', function(){
  if (isEdit) { updatePreview(); return }
  const v = this.value
  firstSection.style.display = v === 'first' ? '' : 'none'
  nextSection.style.display = v === 'next' ? '' : 'none'
  updatePreview()
})

function addFirstRow() {
  const idx = parseInt(firstTotal.value || '0')
  const row = document.createElement('div')
  row.className = 'inline-row'
  row.innerHTML = `
    <select name="first-${idx}-size" required>
      <option value="">Size</option>
      <option value="small">small</option>
      <option value="medium">medium</option>
      <option value="large">large</option>
    </select>
    <input type="text" name="first-${idx}-label" placeholder="Label" required>
    <input type="text" name="first-${idx}-pills" placeholder="No. of pills" required>
    <select name="first-${idx}-time" required>
      <option value="Day">Day</option>
      <option value="Morning">Morning</option>
      <option value="Night">Night</option>
    </select>
    <input type="text" name="first-${idx}-special" placeholder="Special instruction">
    <button type="button" class="remove-btn">Remove</button>
  `
  firstList.appendChild(row)
  row.querySelector('.remove-btn').addEventListener('click', function(){ row.remove(); recomputeFirst(); updatePreview() })
  firstTotal.value = idx + 1
  updatePreview()
}

function addNextRow() {
  const idx = parseInt(nextTotal.value || '0')
  const row = document.createElement('div')
  row.className = 'inline-row next'
  row.innerHTML = `
    <input type="text" name="next-${idx}-bottle" placeholder="Bottle No." required>
    <input type="text" name="next-${idx}-pills" placeholder="No. of pills" required>
    <select name="next-${idx}-dose" required>
      <option value="one">one</option>
      <option value="two">two</option>
      <option value="three">three</option>
      <option value="four">four</option>
      <option value="five">five</option>
    </select>
    <select name="next-${idx}-time" required>
      <option value="Day">Day</option>
      <option value="Morning">Morning</option>
      <option value="Night">Night</option>
    </select>
    <button type="button" class="remove-btn">Remove</button>
  `
  nextList.appendChild(row)
  row.querySelector('.remove-btn').addEventListener('click', function(){ row.remove(); recomputeNext(); updatePreview() })
  nextTotal.value = idx + 1
  updatePreview()
}

function recomputeFirst(){
  const rows = Array.from(firstList.children)
  rows.forEach((row, newIdx) => {
    Array.from(row.querySelectorAll('select,input')).forEach(inp => {
      const name = inp.getAttribute('name')
      if (name && name.startsWith('first-')) {
        const parts = name.split('-')
        parts[1] = String(newIdx)
        inp.setAttribute('name', parts.join('-'))
      }
    })
  })
  firstTotal.value = rows.length
}

function recomputeNext(){
  const rows = Array.from(nextList.children)
  rows.forEach((row, newIdx) => {
    Array.from(row.querySelectorAll('select,input')).forEach(inp => {
      const name = inp.getAttribute('name')
      if (name && name.startsWith('next-')) {
        const parts = name.split('-')
        parts[1] = String(newIdx)
        inp.setAttribute('name', parts.join('-'))
      }
    })
  })
  nextTotal.value = rows.length
}

function updatePreview(){
  const name = patientSelect.options[patientSelect.selectedIndex]?.text || ''
  const caseNo = caseNumber.value || ''
  const lang = languageSelect?.value || 'en'
  const lines = []
  if (lang === 'gu') {
    lines.push('દવાઓ વિતરણ માટેની સૂચનાઓ')
    lines.push('પ્રતિ,')
    lines.push(`${name} (કેસ નં. ${caseNo}),`)
    lines.push('તમે નીચે મુજબ ક્રમમાં હોમિયોપેથી દવા લેવી છે:')
    lines.push('')
    lines.push('પ્રથમ દિવસે:')
  } else {
    lines.push('Instructions for Medicinal Distribution')
    lines.push('To,')
    lines.push(`${name} (Case No. ${caseNo}),`)
    lines.push('You have to take Homeopathic medicine in the following order:')
    lines.push('')
    lines.push('On first day:')
  }
  Array.from(firstList.children).forEach(row => {
    const size = row.querySelector('select[name*="size"]').value
    const label = row.querySelector('input[name*="label"]').value
    const pills = row.querySelector('input[name*="pills"]').value
    const time = row.querySelector('select[name*="time"]').value
    const special = row.querySelector('input[name*="special"]').value
    let base = `☑ ${size} bottle: Labeled as ‘${label}’: take ${pills} pills at ${time}.`
    if (special) base = `☑ ${size} bottle: Labeled as ‘${label}’: take ${pills} pills at ${time} ${special}`
    lines.push(base)
  })
  lines.push('')
  lines.push(lang === 'gu' ? 'આગલા દિવસોથી આગળ:' : 'From Next day onwards:')
  Array.from(nextList.children).forEach(row => {
    const bottle = row.querySelector('input[name*="bottle"]').value
    const pills = row.querySelector('input[name*="pills"]').value
    const dose = row.querySelector('select[name*="dose"]').value
    const time = row.querySelector('select[name*="time"]').value
    lines.push(`☑ From Bottle No. ${bottle}: ${pills} pills, ${dose} times a ${time}.`)
  })
  lines.push('')
  const ami = document.getElementById('docAmi')?.checked
  const kaushal = document.getElementById('docKaushal')?.checked
  if (ami && kaushal) {
    lines.push('Dr. Ami Bhatt                Dr. Kaushal Bhatt')
  } else if (ami) {
    lines.push('Dr. Ami Bhatt')
  } else if (kaushal) {
    lines.push('Dr. Kaushal Bhatt')
  } else {
    lines.push('Dr. Ami Bhatt                Dr. Kaushal Bhatt')
  }
  preview.textContent = lines.join('\n')
}

addFirst.addEventListener('click', addFirstRow)
addNext.addEventListener('click', addNextRow)
if ((parseInt(firstTotal.value||'0') || firstList.children.length) === 0) {
  addFirstRow()
}
updatePreview()
</script>
{% endblock body %}
languageSelect.addEventListener('change', updatePreview)
